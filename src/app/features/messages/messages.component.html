<mat-sidenav-container class="h-screen bg-gray-900 text-white">
  <!-- Left Sidebar: Contacts/Conversations -->
  <mat-sidenav mode="side" opened class="w-64 bg-gray-800">
    <!-- Current User Profile -->
    <div class="p-4 flex items-center bg-gray-700">
      <img class="w-10 h-10 rounded-full mr-2" [src]="currentUserAvatar || 'default.png'" alt="Current User">
      <div>
        <span class="font-bold">{{ currentUserName }}</span>
        <span class="text-sm text-gray-400">{{ currentUserEmail }}</span>
      </div>
    </div>
    <!-- Search -->
    <mat-toolbar class="bg-gray-800">
      <mat-form-field appearance="outline" class="w-full">
        <mat-label>Search Contacts</mat-label>
        <input matInput [(ngModel)]="searchQuery" (ngModelChange)="filterConversations()" placeholder="Search Contacts">
        <svg-icon [src]="getIconPath('magnifying-glass')" class="text-gray-400" matSuffix></svg-icon>
      </mat-form-field>
    </mat-toolbar>
    <!-- Conversations List -->
    <mat-list>
      <mat-list-item *ngFor="let conv of filteredConversations" (click)="selectConversation(conv)">
        <img matListItemAvatar [src]="conv.otherUser.avatar || 'default.png'" alt="{{conv.otherUser.name}}">
        <span matListItemTitle>{{conv.otherUser.name}}</span>
        <span matListItemLine>{{conv.lastMessage?.content?.substring(0, 50) || 'No messages yet'}}</span>
        <span class="text-xs text-gray-400 ml-auto">{{conv.lastMessage?.timestamp | date:'shortTime'}}</span>
      </mat-list-item>
    </mat-list>
  </mat-sidenav>
  <!-- Right Chat Window -->
  <mat-sidenav-content class="flex flex-col">
    <!-- Chat Header -->
    <mat-toolbar class="bg-gray-800" *ngIf="selectedConversation">
      <img class="w-10 h-10 rounded-full mr-2" [src]="selectedConversation.otherUser.avatar || 'default.png'" alt="{{selectedConversation.otherUser.name}}">
      <span>{{selectedConversation.otherUser.name}}</span>
      <span class="flex-1"></span>
      <svg-icon [src]="getIconPath('ellipsis-vertical')" class="text-white"></svg-icon>
    </mat-toolbar>
    <!-- Messages List with Attachments -->
    <div class="flex-1 overflow-y-auto p-4 bg-gray-900" *ngIf="!loadingMessages; else loader">
      <div *ngFor="let msg of messages" class="mb-4 flex" [ngClass]="{'justify-end': msg.senderId === currentUserId}">
        <div class="flex" [ngClass]="{'flex-row-reverse': msg.senderId === currentUserId}">
          <img *ngIf="msg.senderId !== currentUserId" class="w-8 h-8 rounded-full mr-2" [src]="getAvatarForMessage(msg.senderId)" alt="{{msg.senderId}}">
          <div class="chat-bubble" [ngClass]="{'sent': msg.senderId === currentUserId, 'received': msg.senderId !== currentUserId}">
            <p class="m-0" *ngIf="!msg.attachment">{{msg.content}}</p>
            <ng-container *ngIf="msg.attachment">
              <img *ngIf="isImage(msg.attachment)" [src]="getAttachmentUrl(msg.attachment)" class="max-w-xs rounded">
              <a *ngIf="!isImage(msg.attachment)" [href]="getAttachmentUrl(msg.attachment)" download class="text-blue-400">Download {{getFileName(msg.attachment)}}</a>
            </ng-container>
            <span class="text-xs text-gray-400">{{msg.timestamp | date:'short'}}</span>
            <span *ngIf="msg.readBy?.length === 2" class="text-xs text-green-400">✓✓</span>
          </div>
        </div>
      </div>
    </div>
    <ng-template #loader><mat-spinner></mat-spinner></ng-template>
    <!-- Send Input with File Icon -->
    <div class="p-4 bg-gray-800 flex" *ngIf="selectedChannelId">
      <label for="fileInput" class="mr-2 cursor-pointer">
        <svg-icon [src]="getIconPath('paper-clip')" class="text-white"></svg-icon>
      </label>
      <input id="fileInput" type="file" (change)="onFileChange($event)" class="hidden">
      <mat-form-field appearance="outline" class="flex-1 mr-2">
        <input matInput [(ngModel)]="newMessage" placeholder="Send message" (keyup.enter)="sendMessage()">
      </mat-form-field>
      <button mat-raised-button color="primary" (click)="sendMessage()">Send</button>
      <button mat-raised-button color="accent" (click)="sendWithFile()" *ngIf="file">Send File</button>
    </div>
  </mat-sidenav-content>
</mat-sidenav-container>
